<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ù…Ø± Ø¹Ù…Ù„ - Ø§Ù„ÙˆØ±Ø´Ø©</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            background: #f3f4f6;
            padding-bottom: 50px;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: var(--primary);
            font-size: 24px;
            margin: 0;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .info-item label {
            display: block;
            color: #64748b;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .info-item span {
            font-weight: 700;
            color: #1e293b;
            font-size: 16px;
        }

        .diagram-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            /* Default screen size */
            margin: 0 auto 30px;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            overflow: hidden;
            cursor: crosshair;
        }

        .diagram-container img {
            width: 100%;
            display: block;
            user-select: none;
        }

        .defect-mark {
            position: absolute;
            width: 24px;
            height: 24px;
            background: rgba(239, 68, 68, 0.8);
            border-radius: 50%;
            border: 2px solid white;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            pointer-events: none;
        }

        .defect-mark::after {
            content: 'Ã—';
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            font-weight: bold;
            line-height: 1;
        }

        .notes-section,
        .terms-section,
        .signature-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 10px;
            color: var(--primary);
        }

        textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-family: inherit;
        }

        .signature-box {
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            background: #fff;
            height: 150px;
            position: relative;
        }

        canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        .clear-sig {
            position: absolute;
            bottom: 5px;
            left: 5px;
            font-size: 12px;
            background: #eee;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
        }

        .print-actions {
            position: sticky;
            bottom: 20px;
            background: white;
            padding: 15px;
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            gap: 15px;
            max-width: 900px;
            margin: 0 auto;
            border: 1px solid #e5e7eb;
        }

        /* A4 Print Optimization */
        @media print {
            @page {
                size: A4;
                margin: 5mm;
            }

            body {
                background: white;
                font-size: 11px;
                color: #000;
                padding: 0;
            }

            .container {
                box-shadow: none;
                margin: 0;
                padding: 5px;
                max-width: 100%;
                border: none;
            }

            .header {
                padding-bottom: 5px !important;
                margin-bottom: 10px !important;
                border-bottom: 2px solid #000 !important;
            }

            .header h1 {
                font-size: 18px;
                margin-bottom: 5px;
            }

            .header h2 {
                font-size: 16px;
                margin: 0;
            }

            .header p {
                margin: 2px 0;
                font-size: 10px;
            }

            /* Grid Layout */
            .info-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 5px;
                padding: 0;
                margin-bottom: 10px;
                background: none !important;
                border: none;
            }

            .info-item {
                border: 1px solid #ddd;
                padding: 4px;
                border-radius: 4px;
            }

            .info-item label {
                font-size: 9px;
                margin-bottom: 0;
                color: #555;
            }

            .info-item span {
                font-size: 11px;
                font-weight: bold;
                color: #000;
            }

            /* Table */
            table {
                font-size: 10px;
                margin-bottom: 10px !important;
                width: 100%;
            }

            th,
            td {
                padding: 4px !important;
                border: 1px solid #000 !important;
            }

            /* Diagram - Optimized Size */
            .diagram-container {
                max-width: 80% !important;
                /* Proper width for A4 */
                margin: 10px auto !important;
                border: none !important;
            }

            .section-title {
                font-size: 13px;
                margin-bottom: 5px;
                padding-bottom: 2px;
            }

            .notes-section,
            .terms-section,
            .signature-section {
                margin-bottom: 5px;
                page-break-inside: avoid;
            }

            textarea {
                border: 1px solid #000;
                min-height: 40px;
                font-size: 10px;
            }

            /* Bottom Layout */
            .signature-box {
                height: 60px;
                border: 1px solid #000;
            }

            .clear-sig,
            .print-actions {
                display: none !important;
            }

            ul {
                padding-right: 15px;
                margin: 0;
            }

            li {
                margin-bottom: 2px;
                font-size: 9px !important;
            }
        }
    </style>
</head>

<body>
    <div class="container" id="printableArea">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <h1 id="shopName">...</h1>
                <p id="shopDesc">...</p>
                <p>Ø¬ÙˆØ§Ù„: <span id="shopPhone">...</span> | Ø¶Ø±ÙŠØ¨ÙŠ: <span id="shopVat">...</span></p>
            </div>
            <div style="text-align: left;">
                <h2 style="font-weight: 900; font-size: 24px;">Ø£Ù…Ø± Ø¹Ù…Ù„ / Job Order</h2>
                <div
                    style="border: 2px solid red; color: red; padding: 5px 15px; border-radius: 6px; display: inline-block; margin: 5px 0;">
                    <h3 style="margin:0;">#<span id="orderId">...</span></h3>
                </div>
                <p style="font-weight:bold;">Ø§Ù„ØªØ§Ø±ÙŠØ®: <span id="orderDate">...</span></p>
            </div>
        </div>

        <!-- Info -->
        <div class="info-grid">
            <div class="info-item"><label>Ø§Ù„Ø¹Ù…ÙŠÙ„</label><span id="custName">-</span></div>
            <div class="info-item"><label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label><span id="custPhone">-</span></div>
            <div class="info-item"><label>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label><span id="carType">-</span></div>
            <div class="info-item"><label>Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</label><span id="plateNum">-</span></div>
            <div class="info-item"><label>Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„/Ø§Ù„Ù„ÙˆÙ†</label><span id="carModelColor">-</span></div>
            <div class="info-item"><label>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label><span id="inspectorName">-</span></div>
        </div>

        <!-- Services -->
        <div class="section-title">ğŸ“‹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</div>
        <table style="width:100%; border-collapse: collapse; margin-bottom: 20px;">
            <thead>
                <tr style="background:#f1f5f9;">
                    <th style="padding:10px; text-align:right;">Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                    <th style="padding:10px; text-align:center;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th style="padding:10px; text-align:center;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="servicesList"></tbody>
        </table>

        <!-- Visual Inspection -->
        <div class="section-title">ğŸš— Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¸Ø§Ù‡Ø±ÙŠ (Ø¹Ù„Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¶Ø±Ø§Ø±)</div>
        <p class="no-print" style="font-size:12px; color:gray; margin-bottom:10px;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ø®Ø¯ÙˆØ´
            Ø£Ùˆ Ø§Ù„ØµØ¯Ù…Ø§Øª.</p>
        <div class="diagram-container" id="diagramContainer">
            <img src="car_diagram.svg" alt="Car Diagram">
        </div>

        <!-- Notes -->
        <div class="notes-section">
            <div class="section-title">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙÙ†ÙŠ / Ø§Ù„ÙˆØ±Ø´Ø©</div>
            <textarea id="jobNotes" placeholder="Ø§ÙƒØªØ¨ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù‡Ù†Ø§..."></textarea>
        </div>

        <!-- Terms -->
        <div class="terms-section">
            <div class="section-title">âš ï¸ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…</div>
            <ul id="termsList" style="font-size:11px; color:#333; padding-right:20px; font-weight: 500;">
                <!-- Terms injected here -->
            </ul>
        </div>

        <!-- Declaration -->
        <div style="border: 1px solid #000; padding: 5px; margin-bottom: 5px; font-size: 10px; background: #f9f9f9;">
            <strong>Ø¥Ù‚Ø±Ø§Ø±:</strong> Ù†Ø¹Ù…ØŒ Ø£Ù†Ø§ ØµØ§Ø­Ø¨ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ù…ÙˆØ¶Ø­Ø© Ø£Ø¹Ù„Ø§Ù‡ØŒ Ø£Ù‚Ø± Ø¨Ø£Ù†Ù†ÙŠ Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø³ÙŠØ§Ø±ØªÙŠ
            ÙˆØ¨Ù†ÙØ³ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ØŒ ÙˆÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ø¬Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¯ÙˆÙ† Ø±Ø¨Ø·Ù‡Ø§
            Ø¨Ø£Ø¬Ø±Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©ØŒ ÙˆØ¹Ù„Ù‰ Ø°Ù„Ùƒ Ø¬Ø±Ù‰ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹.
        </div>

        <!-- Signature -->
        <div class="signature-section">
            <div class="section-title">âœï¸ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
            <div class="signature-box" style="height: 60px;">
                <canvas id="sigCanvas"></canvas>
                <div class="clear-sig" onclick="clearSignature()">Ù…Ø³Ø­ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ âŒ</div>
            </div>
        </div>

        <!-- Footer -->
        <div style="text-align:center; margin-top:30px; border-top:1px solid #eee; padding-top:10px; font-size:12px;">
            <p>Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§</p>
        </div>
    </div>

    <div class="print-actions">
        <button class="btn btn-secondary" onclick="window.history.back()">ğŸ”™ Ø±Ø¬ÙˆØ¹</button>
        <button class="btn btn-primary" onclick="saveOrder()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
        <button class="btn btn-success" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('id');
        let currentInspection = null;

        // Diagram Logic
        const diagramContainer = document.getElementById('diagramContainer');
        const defects = [];

        if (diagramContainer) {
            diagramContainer.addEventListener('click', (e) => {
                const rect = diagramContainer.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                addMark(x, y);
                defects.push({ x, y });
            });
        }

        function addMark(x, y) {
            const mark = document.createElement('div');
            mark.className = 'defect-mark';
            mark.style.left = x + '%';
            mark.style.top = y + '%';
            mark.onclick = (e) => {
                e.stopPropagation();
                mark.remove();
            };
            diagramContainer.appendChild(mark);
        }

        // Signature Logic
        const canvas = document.getElementById('sigCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        function resizeCanvas() {
            if (!canvas || !canvas.parentElement) return;
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
        }
        window.addEventListener('resize', resizeCanvas);
        setTimeout(resizeCanvas, 500);

        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', endDraw);
        canvas.addEventListener('touchstart', (e) => { startDraw(e.touches[0]); e.preventDefault(); });
        canvas.addEventListener('touchmove', (e) => { draw(e.touches[0]); e.preventDefault(); });
        canvas.addEventListener('touchend', endDraw);

        function startDraw(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo((e.clientX || e.pageX) - rect.left, (e.clientY || e.pageY) - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo((e.clientX || e.pageX) - rect.left, (e.clientY || e.pageY) - rect.top);
            ctx.stroke();
        }

        function endDraw() { isDrawing = false; }
        function clearSignature() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

        // Data Loading
        async function loadOrder() {
            if (!orderId) return alert('No Order ID');

            try {
                // Fetch Settings & Terms First
                try {
                    const [setRes, termRes] = await Promise.all([
                        fetch('/api/settings'),
                        fetch('/api/terms')
                    ]);
                    const settings = await setRes.json();
                    const terms = await termRes.json();

                    if (settings.workshop_name) document.getElementById('shopName').textContent = settings.workshop_name;
                    if (settings.workshop_desc) document.getElementById('shopDesc').textContent = settings.workshop_desc;
                    if (settings.workshop_phone) document.getElementById('shopPhone').textContent = settings.workshop_phone;
                    if (settings.vat_number) document.getElementById('shopVat').textContent = settings.vat_number;

                    const termList = document.getElementById('termsList');
                    if (termList && terms.length > 0) {
                        termList.innerHTML = terms.map(t => `<li>${t.term}</li>`).join('');
                    } else if (termList) {
                        // Default terms if none found
                        termList.innerHTML = `
                            <li>ÙŠØªÙ… Ø¯ÙØ¹ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ù‚Ø¨Ù„ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©.</li>
                            <li>ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ø­ØªÙŠØ§Ø¬ Ù„Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± ÙŠØ¨Ù„Øº ØµØ§Ø­Ø¨Ù‡Ø§ Ø¨Ù…Ø§ ÙŠØ­ØªØ§Ø¬ ÙˆÙŠØ¹Ø·ÙŠ Ù…Ù‡Ù„Ø© Ø®Ù…Ø³Ø© Ø£ÙŠØ§Ù… Ù„ØªØ£Ù…ÙŠÙ† Ø§Ù„Ù‚Ø·Ø¹ØŒ ÙˆÙÙŠ Ø­Ø§Ù„Ø© ØªØ£Ø®Ø±Ù‡ Ø¹Ù† ØªØ£Ù…ÙŠÙ† Ø§Ù„Ù‚Ø·Ø¹ Ø£Ùˆ ÙÙŠ Ø­Ø§Ù„Ø© ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙˆÙ„Ù… ÙŠØ³ØªÙ„Ù…Ù‡Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø£ÙƒØ«Ø± Ù…Ù† 3 Ø£ÙŠØ§Ù… ÙØ¥Ù† Ø§Ù„Ù…Ø±ÙƒØ² ØºÙŠØ± Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø£Ùˆ Ø¹Ù† Ø£ÙŠ Ù…Ø®Ø§Ù„ÙØ§Øª ØªØµØ¯Ø± Ø¹Ù„ÙŠÙ‡Ø§.</li>
                            <li>Ø§Ù„Ù…Ø±ÙƒØ² Ù„Ø§ ÙŠØªØ­Ù…Ù„ Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© ØªØºÙŠÙŠØ± Ø²ÙŠØª Ø§Ù„Ø¬ÙŠØ±Ø¨ÙƒØ³ Ø£Ùˆ ØªØ²ÙˆÙŠØ¯ ((Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¶Ù…Ø§Ù†)).</li>
                            <li>Ø§Ù„Ù…Ø±ÙƒØ² ØºÙŠØ± Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„ØªÙŠ ØªÙ… ØªØºÙŠÙŠØ±Ù‡Ø§ ÙˆØªØ±ÙƒÙ‡Ø§ ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ² Ø¹Ù† Ù…Ø¯Ø© ØªØ²ÙŠØ¯ Ø¹Ù† 3 Ø£ÙŠØ§Ù….</li>
                            <li>Ø§Ù„Ù…Ø±ÙƒØ² ØºÙŠØ± Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„ØªÙŠ ØªØ¸Ù‡Ø± ÙˆØ§Ù„ØªÙŠ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§ØªÙØ§Ù‚ Ø¹Ù„Ù‰ Ø¥ØµÙ„Ø§Ø­Ù‡Ø§.</li>
                            <li>Ø§Ù„Ù…Ø±ÙƒØ² ØºÙŠØ± Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† ÙƒØ´Ù Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¨Ø¹Ø¯ 7 Ø£ÙŠØ§Ù… Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„ÙƒØ´Ù.</li>
                         `;
                    }
                } catch (e) {
                    console.log('Settings load error', e);
                }

                // Fetch Order
                const res = await fetch(`/api/inspections/${orderId}`);
                if (!res.ok) throw new Error('Inspection not found');

                const data = await res.json();
                currentInspection = data;

                document.getElementById('orderId').textContent = data.id;
                document.getElementById('orderDate').textContent = new Date(data.created_at).toLocaleDateString('en-GB'); // Proper Date Format
                document.getElementById('custName').textContent = data.customer_name;
                document.getElementById('custPhone').textContent = data.customer_phone;
                document.getElementById('carType').textContent = data.car_type;
                document.getElementById('plateNum').textContent = data.plate_number;
                document.getElementById('carModelColor').textContent = `${data.car_model || ''} / ${data.car_color || ''}`;
                document.getElementById('inspectorName').textContent = data.inspector_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                document.getElementById('jobNotes').value = data.job_order_notes || '';

                // Load Services
                const tbody = document.getElementById('servicesList');
                tbody.innerHTML = '';
                if (data.items && data.items.length > 0) {
                    data.items.forEach(item => {
                        tbody.innerHTML += `
                            <tr style="border-bottom:1px solid #eee;">
                                <td style="padding:10px;">${item.service_description} <small style="color:#666">(${item.category || 'Ø¹Ø§Ù…'})</small></td>
                                <td style="padding:10px; text-align:center;">${item.quantity}</td>
                                <td style="padding:10px; text-align:center;"></td>
                            </tr>
                        `;
                    });
                } else {
                    tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø¯Ù…Ø§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>`;
                }

                // Load Defects
                if (data.car_defects_diagram) {
                    try {
                        const savedDefects = JSON.parse(data.car_defects_diagram);
                        savedDefects.forEach(d => {
                            addMark(d.x, d.y);
                            defects.push(d);
                        });
                    } catch (e) { console.error("Error parsing defects", e); }
                }

            } catch (error) {
                console.error(error);
                alert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ù…Ø± Ø§Ù„Ø¹Ù…Ù„: ' + error.message);
            }
        }

        async function saveOrder() {
            try {
                // Collect Visual Marks
                const finalDefects = [];
                document.querySelectorAll('.defect-mark').forEach(el => {
                    finalDefects.push({
                        x: parseFloat(el.style.left),
                        y: parseFloat(el.style.top)
                    });
                });

                const payload = {
                    ...currentInspection,
                    job_order_notes: document.getElementById('jobNotes').value,
                    car_defects_diagram: JSON.stringify(finalDefects)
                };

                const res = await fetch(`/api/inspections/${orderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    const err = await res.json();
                    alert('âŒ Ø®Ø·Ø£: ' + err.message);
                }

            } catch (e) {
                console.error(e);
                alert('Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸');
            }
        }

        loadOrder();
    </script>
</body>

</html>